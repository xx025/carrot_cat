<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>èåœçŒ« CarrotCat</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Noto Sans CJK SC", Arial; margin: 0; background:#f6f7fb; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 16px; }
    .card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    canvas { width: 100%; height: 420px; display:block; border-radius: 12px; background: linear-gradient(#eaf3ff, #ffffff); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top: 12px; }
    input { flex: 1; min-width: 220px; padding: 10px 12px; border-radius: 10px; border:1px solid #d7dbe7; font-size: 16px; }
    button { padding: 10px 14px; border-radius: 10px; border:0; background:#111827; color:white; font-size: 16px; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .hint { color:#6b7280; font-size: 13px; margin-top: 8px; }
    .log { margin-top: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; color:#374151; background:#f3f4f6; padding: 10px; border-radius: 12px; white-space: pre-wrap; }
    .badge { display:inline-block; padding:2px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; margin-left: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">èåœçŒ« <span class="badge">å¼ºåŒ–å­¦ä¹ èµ›åšçŒ«</span></h2>
      <canvas id="scene" width="960" height="420"></canvas>

      <div class="row">
        <button id="q1">ğŸ§»</button>
        <button id="q2">ğŸ¥•</button>
        <button id="askBtn" disabled>åŠ è½½æ¨¡å‹ä¸­...</button>
        <button id="awesomeBtn">çœŸæ£’</button>
      </div>

      <div class="hint">
        æ“ä½œï¼šé”®ç›˜ â† â†’ å¯ä»¥æ‰‹åŠ¨ç§»åŠ¨çŒ«ï¼›ç‚¹å‡»ğŸ§»æˆ–ğŸ¥•æŒ‰é’®ç›´æ¥æé—®ï¼Œæˆ–ç‚¹å‡»â€œéšæœºæé—®â€è®©æ¨¡å‹éšæœºé€‰æ‹©é—®é¢˜ã€‚<br>
        å½“çŒ«ç­”å¯¹æ—¶ï¼Œç‚¹å‡»â€œçœŸæ£’â€æŒ‰é’®è®©çŒ«è·³èµ·æ¥åƒå°é±¼å¹²ï¼Œç„¶åè½¬åœˆåº†ç¥ï¼
      </div>

      <div class="log" id="log">log:\n- æ­£åœ¨åŠ è½½ onnxruntime-web...\n</div>
    </div>
  </div>

  <!-- éŸ³é¢‘å…ƒç´  -->
  <audio id="paperAudio" src="static/music/paper.MP3" preload="auto"></audio>
  <audio id="carrotAudio" src="static/music/carrot.MP3" preload="auto"></audio>
  <audio id="goodAudio" src="static/music/good.MP3" preload="auto"></audio>

  <!-- onnxruntime-web (çº¯ JS) -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

  <script>
    const MODEL_URL = "./models/luobo_cat_policy.onnx";
    const SPEED = 5;
    const canvas = document.getElementById("scene");
    const ctx = canvas.getContext("2d");
    const logEl = document.getElementById("log");
    const askBtn = document.getElementById("askBtn");
    const q1Btn = document.getElementById("q1");
    const q2Btn = document.getElementById("q2");
    const awesomeBtn = document.getElementById("awesomeBtn");

    // éŸ³é¢‘å…ƒç´ 
    const paperAudio = document.getElementById("paperAudio");
    const carrotAudio = document.getElementById("carrotAudio");
    const goodAudio = document.getElementById("goodAudio");

    let session = null;
    let catCorrect = false;
    let spinning = false;
    let spinAngle = 0;
    let fishJerky = { x: 0, y: -50, active: false, speed: 2 };
    let catJumpOffset = 0;
    let jumping = false;

    // åœºæ™¯å¸ƒå±€ï¼ˆåƒç´ åæ ‡ï¼‰
    const floorY = 310;

    const tissue = { x: 240, y: floorY, w: 120, h: 70, label: "çº¸å·¾", obs: 0, emoji: "ğŸ§»" };
    const carrot = { x: 600, y: floorY, w: 120, h: 70, label: "èåœ", obs: 1, emoji: "ğŸ¥•" };

    // çŒ«
    const cat = {
      x: 80,
      y: floorY - 90,
      targetX: 80,
      w: 90,
      h: 90,
      facing: 1, // 1 right, -1 left
      pawDown: false,
      pawTimer: 0
    };

    function log(msg) {
      logEl.textContent += msg + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    /********************
     * ç»˜åˆ¶
     ********************/
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // åœ°é¢
      ctx.fillStyle = "rgba(0,0,0,0.06)";
      ctx.fillRect(0, floorY + 70, canvas.width, 8);

      // ç‰©ä½“
      drawObject(tissue, "#e5e7eb");
      drawObject(carrot, "#fde68a");

      // çŒ«
      drawCat();

      // å°é±¼å¹²
      if (fishJerky.active) {
        // èƒŒæ™¯åœ†
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(fishJerky.x + 12, fishJerky.y - 10, 20, 0, Math.PI * 2);
        ctx.fill();
        // è¡¨æƒ…
        ctx.font = "32px system-ui";
        ctx.fillText("ğŸŸ", fishJerky.x, fishJerky.y);
      }

      // æç¤ºçº¿ï¼ˆçŒ«ç›®æ ‡ï¼‰
      ctx.strokeStyle = "rgba(59, 130, 246, 0.35)";
      ctx.setLineDash([6, 6]);
      ctx.beginPath();
      ctx.moveTo(cat.x + cat.w/2, cat.y + cat.h);
      ctx.lineTo(cat.targetX + cat.w/2, cat.y + cat.h);
      ctx.stroke();
      ctx.setLineDash([]);
    }

    function drawObject(obj, color) {
      // ç›’å­
      ctx.fillStyle = color;
      roundRect(ctx, obj.x, obj.y, obj.w, obj.h, 14);
      ctx.fill();

      // è¡¨æƒ…
      ctx.fillStyle = "#111827";
      ctx.font = "32px system-ui";
      ctx.fillText(obj.emoji, obj.x + 38, obj.y + 42);

      // åº•åº§
      ctx.fillStyle = "rgba(0,0,0,0.08)";
      roundRect(ctx, obj.x + 10, obj.y + obj.h - 8, obj.w - 20, 16, 10);
      ctx.fill();
    }

    function drawCat() {
      ctx.save();
      const centerX = cat.x + cat.w / 2;
      const centerY = cat.y + cat.h / 2 + catJumpOffset;
      ctx.translate(centerX, centerY);
      ctx.rotate(spinAngle);
      ctx.translate(-centerX, -centerY);

      // èƒŒæ™¯åœ†
      ctx.fillStyle = "white";
      ctx.beginPath();
      ctx.arc(cat.x + 45, cat.y + 45 + catJumpOffset, 40, 0, Math.PI * 2);
      ctx.fill();

      // çŒ«è¡¨æƒ…
      ctx.font = "48px system-ui";
      ctx.fillText("ğŸ±", cat.x + 10, cat.y + 60 + catJumpOffset);

      ctx.restore();

      // è„šæŒï¼ˆpawDown æ—¶ç”»ä¸€ä¸ªå°çˆªå°ï¼‰
      if (cat.pawDown) {
        ctx.fillStyle = "rgba(239,68,68,0.85)";
        const pawX = cat.x + cat.w/2 + (cat.facing * 20);
        const pawY = cat.y + cat.h + 8 + catJumpOffset;
        ctx.beginPath(); ctx.arc(pawX, pawY, 7, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(pawX - 10, pawY - 6, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(pawX + 10, pawY - 6, 4, 0, Math.PI*2); ctx.fill();
      }
    }

    function roundRect(ctx, x, y, w, h, r) {
      const min = Math.min(w, h);
      if (r > min/2) r = min/2;
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y,   x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x,   y+h, r);
      ctx.arcTo(x,   y+h, x,   y,   r);
      ctx.arcTo(x,   y,   x+w, y,   r);
      ctx.closePath();
    }

    function tick() {
      // ç§»åŠ¨çŒ«åˆ° targetX
      const dx = cat.targetX - cat.x;
      if (Math.abs(dx) > 1) {
        cat.x += Math.sign(dx) * SPEED;
        cat.facing = Math.sign(dx);
      }

      // pawDown å®šæ—¶æ¶ˆå¤±
      if (cat.pawDown) {
        cat.pawTimer -= 1;
        if (cat.pawTimer <= 0) {
          cat.pawDown = false;
        }
      }

      // æ—‹è½¬é€»è¾‘
      if (spinning) {
        spinAngle += 0.1;
        if (spinAngle > 2 * Math.PI) {
          spinning = false;
          spinAngle = 0;
        }
      }

      // å°é±¼å¹²æ‰è½
      if (fishJerky.active) {
        fishJerky.y += fishJerky.speed;
        // æ£€æµ‹æ˜¯å¦æ‰åˆ°çŒ«ä¸Šæ–¹å¹¶åƒæ‰
        const catCenterX = cat.x + cat.w / 2;
        const catTopY = cat.y + catJumpOffset;
        if (fishJerky.y >= catTopY - 20 && Math.abs(fishJerky.x - catCenterX) < 30) {
          fishJerky.active = false;
          jumping = true;
          log("ğŸ± çŒ«å’ªè·³èµ·æ¥åƒæ‰äº†å°é±¼å¹²ï¼");
        } else if (fishJerky.y > canvas.height) {
          fishJerky.active = false;
        }
      }

      // è·³è·ƒé€»è¾‘
      if (jumping) {
        catJumpOffset -= 5; // å‘ä¸Šè·³
        if (catJumpOffset <= -50) { // è·³åˆ°æœ€é«˜ç‚¹
          jumping = false;
        }
      } else if (catJumpOffset < 0) {
        catJumpOffset += 2; // è½ä¸‹
        if (catJumpOffset >= 0) {
          catJumpOffset = 0;
        }
      }

      draw();
      requestAnimationFrame(tick);
    }

    async function loadModel() {
      try {
        log(`- åŠ è½½æ¨¡å‹: ${MODEL_URL}`);
        session = await ort.InferenceSession.create(MODEL_URL, {
          executionProviders: ["wasm"],
        });
        log("- âœ… æ¨¡å‹åŠ è½½æˆåŠŸï¼");
        askBtn.disabled = false;
        askBtn.textContent = "éšæœºæé—®";
      } catch (e) {
        console.error(e);
        log("- âŒ æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„ä¸æµè§ˆå™¨æ§åˆ¶å°æŠ¥é”™ã€‚");
        askBtn.disabled = true;
        askBtn.textContent = "æ¨¡å‹åŠ è½½å¤±è´¥";
      }
    }

    // æŠŠè¾“å…¥ï¼ˆçº¸å·¾/èåœï¼‰è½¬æ¢æˆæ¨¡å‹è§‚æµ‹ï¼š0 æˆ– 1
    function parseQuestion(text) {
      const t = String(text || "").trim();
      if (t === "çº¸å·¾") return 0;
      if (t === "èåœ") return 1;
      return null;
    }

    async function answerByModel(questionObs) {
      if (!session) throw new Error("æ¨¡å‹æœªåŠ è½½");

      const obsData = new Float32Array([questionObs]);
      const obsTensor = new ort.Tensor("float32", obsData, [1, 1]);

      const feeds = { obs: obsTensor };
      const results = await session.run(feeds);

      // è¾“å‡º action: int64 tensor shape [1]
      const actionTensor = results.action;
      let action = actionTensor.data[0];
      if (typeof action === "bigint") action = Number(action);

      return action;
    }

    function moveCatToAction(action) {
      // action 0=è¸©çº¸å·¾, 1=è¸©èåœ
      const target = (action === 0) ? tissue : carrot;

      cat.targetX = target.x + target.w/2 - cat.w/2;

      const check = setInterval(() => {
        if (Math.abs(cat.targetX - cat.x) < 6) {
          clearInterval(check);
          cat.pawDown = true;
          cat.pawTimer = 60; // å¤§çº¦ 1 ç§’
        }
      }, 30);
    }

    /********************
     * æé—®å‡½æ•°
     ********************/
    async function askQuestion(q) {
      const qText = (q === 0 ? "ğŸ§»" : "ğŸ¥•");
      log(`\n[æé—®] äººç±»é—®ï¼š${qText}`);

      try {
        const action = await answerByModel(q);
        const target = action === 0 ? "ğŸ§»" : "ğŸ¥•";
        log(`[æ¨¡å‹è¾“å‡º] action=${action} â†’ çŒ«æŠŠè„šæŒæ”¾åœ¨ï¼š${target}`);
        catCorrect = (action === q);
        if (catCorrect) {
          log("âœ… ç­”å¯¹äº†ï¼ç‚¹å‡»â€œçœŸæ£’â€è®©çŒ«è½¬åœˆåº†ç¥ï¼");
        } else {
          log("âŒ ç­”é”™äº†ã€‚");
        }
        moveCatToAction(action);
      } catch (e) {
        console.error(e);
        log("- âŒ æ¨ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¨¡å‹è¾“å…¥/è¾“å‡ºåæ˜¯å¦åŒ¹é…ï¼Œä»¥åŠæ§åˆ¶å°é”™è¯¯ã€‚");
      }
    }

    q1Btn.addEventListener("click", () => {
      paperAudio.play();
      askQuestion(0);
    });

    q2Btn.addEventListener("click", () => {
      carrotAudio.play();
      askQuestion(1);
    });

    askBtn.addEventListener("click", async () => {
      const q = Math.random() < 0.5 ? 0 : 1;
      if (q === 0) {
        paperAudio.play();
      } else {
        carrotAudio.play();
      }
      askQuestion(q);
    });

    awesomeBtn.addEventListener("click", () => {
      if (catCorrect) {
        goodAudio.play();
        spinning = true;
        spinAngle = 0;
        fishJerky.x = cat.x + cat.w / 2 - 12; // çŒ«ä¸­å¿ƒï¼Œè¡¨æƒ…å®½åº¦çº¦24
        fishJerky.y = -50;
        fishJerky.active = true;
        log("ğŸ‰ çŒ«å’ªè½¬åœˆåº†ç¥ï¼å°é±¼å¹²æ‰ä¸‹æ¥å•¦ï¼");
      } else {
        log("çŒ«å’ªè¿˜æ²¡ç­”å¯¹å‘¢ï¼Œå…ˆè®©å®ƒç­”å¯¹å§ï¼");
      }
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft")  { cat.targetX = Math.max(0, cat.targetX - 40); cat.facing = -1; }
      if (e.key === "ArrowRight") { cat.targetX = Math.min(canvas.width - cat.w, cat.targetX + 40); cat.facing = 1; }
      if (e.key === " ") { cat.pawDown = true; cat.pawTimer = 60; } // ç©ºæ ¼æ”¾è„šæŒ
    });

    tick();
    loadModel();
  </script>
</body>
</html>
